# Servei de Pujada d'Arxius (S4)

El servei `s4-upload` és un microservei especialitzat dedicat exclusivament a la gestió de pujades de fitxers i el processament de publicacions. Aquest servei opera de manera aïllada per gestionar les operacions d'entrada/sortida d'arxius, alliberant als serveis principals (`s2-php` i `s3-php`) d'aquesta càrrega de treball.

## Configuració del Contenidor

- **Imatge**: Construïda des de `php.Dockerfile`
- **Ports**: Exposa el port `9000` internament per a comunicacions FastCGI
- **Xarxes**: Connectat a `extanet` (frontend) i `datanet` (backend)
- **Volums**: 
  - Muntatge del codi PHP al directori `/var/www/html`
  - Muntatge compartit del directori `uploads/` per guardar les imatges pujades

## Fitxer `upload.php` - Processador de Publicacions

### Funcionalitats Principals
- **Gestió de pujades d'imatges**: Processament segur de fitxers amb validació
- **Persistència de dades**: Inserció a la base de dades MySQL (S7)
- **Redirecció segura**: Redirigeix als usuaris cap a l'aplicació principal via HTTPS
- **Gestió d'errors silenciosa**: Evita exposició d'informació sensible en errors

### Flux d'Execució
1. **Recepció de dades**: Rebut del formulari de publicació (`POST`)
2. **Validació de contingut**: Comprovació de l'existència de text a la publicació
3. **Processament d'imatge**: Generació d'ID únic i còpia segura al sistema de fitxers
4. **Persistència a BD**: Inserció del text i referència de la imatge a MySQL
5. **Redirecció**: Tornada a l'aplicació principal amb confirmació

### Codi Complet

```php
<?php
if (!empty($_POST["post"])) {
    $photoid = null;
    
    // Procesar imagen si existe
    if (!empty($_FILES['photo']['name']) && $_FILES['photo']['error'] === UPLOAD_ERR_OK) {
        $photoid = uniqid('img_', true);
        $extension = strtolower(pathinfo($_FILES['photo']['name'], PATHINFO_EXTENSION));
        $photoid .= '.' . $extension;
        
        if (!move_uploaded_file($_FILES['photo']['tmp_name'], 'uploads/' . $photoid)) {
            $photoid = null;
        }
    }
    
    // Conexión a base de datos (S7)
    mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);
    try {
        $db = new mysqli("s7-database", "extagram_admin", "pass123", "extagram_db");
        $db->set_charset("utf8mb4");
        
        $stmt = $db->prepare("INSERT INTO posts (post, photourl) VALUES (?, ?)");
        $stmt->bind_param("ss", $_POST["post"], $photoid);
        $stmt->execute();
        $stmt->close();
        $db->close();
    } catch (mysqli_sql_exception $e) {
        // Error silencioso
    }
}

// Redirigir a HTTPS
header("Location: https://extagram-g2.duckdns.org/?success=1");
exit;
?>