# Documentació Detallada del Proxy Invers (Gateway s1-proxy)

L'arxiu `s1.conf` no és una simple configuració de servidor web; és el **Gateway d'Arquitectura** del projecte **Extagram**. Aquest component actua com el cervell de la xarxa `extanet`, gestionant el trànsit, la seguretat perimetral i l'orquestració de peticions cap als 7 microserveis.

A continuació es detalla el funcionament de cada capa de la configuració.

---

## 1. Arquitectura de Balanceig de Càrrega (Layer 7)

Per garantir l'alta disponibilitat (**High Availability**) i l'escalabilitat horitzontal, el proxy utilitza un mòdul de balanceig de càrrega per a les peticions PHP.

* **Recurs:** `upstream php_backend`
* **Algorisme `ip_hash`:** A diferència del *Round Robin* (que envia peticions aleatòriament), l'algorisme basat en Hash d'IP garanteix que un usuari es mantingui connectat al mateix node de backend. Això és crític per:
    * Mantenir la persistència de les sessions de l'usuari.
    * Reduir la latència de reconnexió.
    * Optimitzar l'ús de la memòria cau local en els servidors d'aplicació (S2 i S3).

---

## 2. Seguretat Perimetral i Protocol TLS

El proxy implementa una capa de seguretat SSL/TLS robusta que protegeix la privadesa dels usuaris d'Extagram:

### Gestió de Certificats
* **Certbot/Let's Encrypt:** El proxy està configurat per llegir els certificats generats des del host (`/etc/letsencrypt`), permetent renovacions automàtiques sense aturar el servei.
* **HSTS (implícit):** Mitjançant la redirecció `301`, s'assegura que cap dada sensible (com contrasenyes en el login) viatgi mai per text pla (HTTP).

### Optimització HTTP/2
* S'habilita el protocol **HTTP/2** al port 443, cosa que permet el multiplexat de peticions. Això significa que el navegador pot descarregar múltiples imatges i estils simultàniament a través d'una sola connexió TCP, accelerant dràsticament el temps de càrrega de la xarxa social.

---

## 3. Estratègia de Segmentació de Trànsit (Microserveis)

El nucli de la configuració resideix en la seva capacitat per segmentar les peticions i enviar-les al microservei més eficient:

### A. Microservei de Continguts Estàtics (`s6-static`)
Les peticions a fitxers estructurals (CSS, SVG, logotips) es gestionen mitjançant una regla de "fallback":
1.  Nginx intenta trobar el fitxer dins del seu propi contenidor.
2.  Si no hi és, executa un `proxy_pass` cap a **S6**.
3.  **Resultat:** Es redueix l'ús de CPU dels servidors PHP, ja que aquests mai arriben a processar peticions de disseny.

### B. Microservei de Lliurament d'Imatges (`s5-images`)
Les imatges pujades pels usuaris (ruta `/uploads/`) es desvien a **S5**.
* Aquest servei està optimitzat exclusivament per al trànsit de sortida d'imatges.
* En utilitzar un subdomini o ruta específica, evitem que les imatges pesades bloquegin les cues d'execució de la lògica de l'app.

### C. Microservei d'Escriptura / Uploads (`s4-upload`)
Es defineix una excepció específica per a `upload.php`:
* **Buffer d'entrada:** S'amplia el `client_max_body_size` a **50M**. Això és vital perquè Nginx, per defecte, bloqueja qualsevol pujada superior a 1MB.
* **Aïllament de càrrega:** En enviar les pujades a **S4**, si un usuari puja una imatge molt pesada, no afecta la velocitat de navegació dels altres usuaris que estan a **S2** o **S3**.

---

## 4. Arxiu de Configuració Professional (`s1.conf`)

```nginx
##############################################################
# CONFIGURACIÓ DE L'UPSTREAM (NODES DE BACKEND)
##############################################################
upstream php_backend {
    ip_hash;                  # Algorisme per a persistència de sessió
    server s2-php:9000;       # Instància de producció A
    server s3-php:9000;       # Instància de producció B
}

##############################################################
# SERVIDOR HTTP (PORT 80) - REDIRECCIÓ OBLIGATÒRIA
##############################################################
server {
    listen 80;
    server_name extagram-g2.duckdns.org;

    # Redirecció permanent a la versió segura
    location / {
        return 301 https://$server_name$request_uri;
    }
}

##############################################################
# SERVIDOR HTTPS (PORT 443) - GATEWAY PRINCIPAL
##############################################################
server {
    listen 443 ssl http2;
    server_name extagram-g2.duckdns.org;

    # Paràmetres SSL (Certificats Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/extagram-g2.duckdns.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/extagram-g2.duckdns.org/privkey.pem;

    # Millores de Seguretat SSL
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # Directori arrel i índexs
    root /var/www/html;
    index extagram.php index.php index.html;

    # Registres de monitorització
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # --------------------------------------------------------
    # 1. GESTIÓ D'ESTÀTICS (CSS, JS, ICONS)
    # --------------------------------------------------------
    location ~ \.(css|svg|ico|jpg|jpeg|png|gif)$ {
        expires 7d;                         # Memòria cau de navegador activa
        add_header Cache-Control "public";  # Permetre caché en proxies intermedis
        try_files $uri @static_proxy;       # Si no hi és localment, demana-ho a S6
    }

    # Proxy intern cap al servidor d'estàtics (S6)
    location @static_proxy {
        proxy_pass http://s6-static;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # --------------------------------------------------------
    # 2. CDN DE FOTOS D'USUARI (Lectura des de S5)
    # --------------------------------------------------------
    location ^~ /uploads/ {
        proxy_pass http://s5-images;
        proxy_set_header Host $host;
    }

    # --------------------------------------------------------
    # 3. MICROSERVEI D'UPLOAD (Processament en S4)
    # --------------------------------------------------------
    location = /upload.php {
        client_max_body_size 50M;           # Límit de pujada per a imatges HD
        
        include fastcgi_params;
        fastcgi_pass s4-upload:9000;        # Enviament directe a S4
        fastcgi_index upload.php;
        fastcgi_param SCRIPT_FILENAME /var/www/html/upload.php;
    }

    # --------------------------------------------------------
    # 4. LÒGICA D'APLICACIÓ (PHP-FPM via FastCGI)
    # --------------------------------------------------------
    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php_backend;           # Balanceig entre S2 i S3
        fastcgi_index extagram.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
    }

    # Ruta d'entrada a l'aplicació
    location = / {
        fastcgi_pass php_backend;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/extagram.php;
    }

    # --------------------------------------------------------
    # 5. SEGURETAT: RESTRICCIÓ D'ACCÈS
    # --------------------------------------------------------
    # Denegar accés a fitxers crítics (p.ex. .htaccess, .git, .env)
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}