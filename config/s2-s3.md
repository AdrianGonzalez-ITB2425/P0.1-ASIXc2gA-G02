# Documentación Técnica Integral: Servicio de Aplicación S2-S3 (Extagram)

Este documento centraliza la especificación funcional, la lógica de negocio y el código fuente de los componentes que integran la capa de aplicación del ecosistema **Extagram**.

---

## 1. Arquitectura y Flujo de Datos
El servicio S2-S3 actúa como el núcleo operativo. Se conecta a una base de datos distribuida (**S7**) y gestiona el sistema de archivos local para el almacenamiento de medios. Utiliza **PHP 8.x** para el procesamiento del lado del servidor y **JavaScript nativo** para la interactividad en el cliente.

---

## 2. Componente: `extagram.php` (Portal de Usuario)

### Análisis de Funcionalidades:
* **Gestión de Internacionalización (i18n):** Implementa un motor de traducción mediante un array asociativo `$t`. La preferencia se almacena en la sesión del servidor (`$_SESSION['lang']`), lo que permite una navegación fluida sin perder el idioma seleccionado.
* **Capa de Datos:** Utiliza el driver `mysqli` con reporte de errores estricto. La consulta recupera los posts en orden cronológico inverso (`DESC`) para priorizar el contenido fresco.
* **Lógica de Interfaz (Frontend):**
    * **Layout Swapping:** Mediante clases CSS y manipulación del DOM, el usuario puede alternar entre vistas de rejilla o listas verticales.
    * **Previsualización de Medios:** Usa la API `FileReader` para cargar imágenes en el navegador antes de que sean enviadas al servidor.

### Código Fuente:
```php
<?php
session_start();

// Control de Idioma
if (!isset($_SESSION['lang'])) { $_SESSION['lang'] = 'es'; }
if (isset($_GET['lang'])) {
    $_SESSION['lang'] = ($_GET['lang'] === 'en') ? 'en' : 'es';
    header('Location: /'); 
    exit;
}
$lang = $_SESSION['lang'];

// Diccionario de Traducciones
$t = [
    'es' => [
        'title' => 'Extagram', 'placeholder' => '¿Qué estás pensando?',
        'upload_image' => 'Click para subir imagen', 'publish' => 'Publicar',
        'login' => 'Iniciar Sesión', 'latest_posts' => 'Últimas Publicaciones',
        'no_posts' => 'No hay publicaciones aún', 'view_grid' => 'Grid',
        'view_vertical' => 'Vertical', 'view_horizontal' => 'Horizontal'
    ],
    'en' => [
        'title' => 'Extagram', 'placeholder' => "What's on mind?",
        'upload_image' => 'Click to upload image', 'publish' => 'Publish',
        'login' => 'Login', 'latest_posts' => 'Latest Posts',
        'no_posts' => 'No posts yet', 'view_grid' => 'Grid',
        'view_vertical' => 'Vertical', 'view_horizontal' => 'Horizontal'
    ]
];

// Conexión a Base de Datos S7
mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);
try {
    $db = new mysqli("s7-database", "extagram_admin", "pass123", "extagram_db");
    $db->set_charset("utf8mb4");
    $result = $db->query("SELECT * FROM posts ORDER BY id DESC LIMIT 50");
    $posts = $result ? $result->fetch_all(MYSQLI_ASSOC) : [];
    $db->close();
} catch (mysqli_sql_exception $e) { 
    $posts = []; // Fallback seguro
}
?>
<!DOCTYPE html>
<html lang="<?php echo $lang; ?>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo $t[$lang]['title']; ?></title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <!-- Header -->
    <header style="background: rgba(168,213,226,0.95); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="display: flex; align-items: center; gap: 12px;">
            <h1 style="font-size: 22px; margin: 0;"><?php echo $t[$lang]['title']; ?></h1>
        </div>
        
        <div style="display: flex; gap: 12px;">
            <button onclick="window.location.href='?lang=<?php echo $lang === 'es' ? 'en' : 'es'; ?>'" style="background: white; color: #7ab8cc; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 500;">
                <?php echo $lang === 'es' ? 'English' : 'Español'; ?>
            </button>
            <button onclick="window.location.href='/admin.php'" style="background: #f7b7a3; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 500;">
                <?php echo $t[$lang]['login']; ?>
            </button>
        </div>
    </header>

    <!-- Hero Section -->
    <section style="background: linear-gradient(135deg, #a8d5e2 0%, #ffd89b 100%); color: white; padding: 100px 20px 80px; text-align: center;">
        <div style="max-width: 700px; margin: 0 auto;">
            <h2 style="font-size: 52px; font-weight: 700; margin-bottom: 16px;">
                <?php echo $lang === 'es' ? 'Comparte tu historia.' : 'Share your story.'; ?>
            </h2>
            <p style="font-size: 20px; margin-bottom: 32px;">
                <?php echo $lang === 'es' ? 'Crea momentos hermosos y compártelos con el mundo.' : 'Create beautiful moments and share them with the world.'; ?>
            </p>
            <button onclick="document.getElementById('createPost').scrollIntoView({behavior: 'smooth'})" style="background: white; color: #7ab8cc; border: none; padding: 14px 40px; font-size: 16px; font-weight: 600; border-radius: 30px; cursor: pointer; box-shadow: 0 4px 14px rgba(0,0,0,0.15);">
                <?php echo $lang === 'es' ? 'Comenzar' : 'Get Started'; ?>
            </button>
        </div>
    </section>

    <!-- Create Post Form -->
    <section id="createPost" style="padding: 60px 20px; background: #faf9f7;">
        <div style="max-width: 600px; margin: 0 auto; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
            <h3 style="font-size: 26px; margin-bottom: 28px;"><?php echo $lang === 'es' ? 'Crear nueva publicación' : 'Create a New Post'; ?></h3>
            
            <form method="POST" enctype="multipart/form-data" action="/upload.php">
                <div style="margin-bottom: 24px;">
                    <label for="file" style="display: block; cursor: pointer;">
                        <div style="position: relative; width: 100%; height: 320px; border: 2px dashed #e2e8f0; border-radius: 16px; background: #f8f9fa; overflow: hidden;">
                            <img id="preview" src="/preview.svg" style="width: 100%; height: 100%; object-fit: contain; padding: 20px;">
                            <div id="uploadText" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #718096; pointer-events: none;">
                                <span><?php echo $t[$lang]['upload_image']; ?></span>
                            </div>
                        </div>
                    </label>
                    <input id="file" type="file" name="photo" accept="image/*" onchange="previewImage(event)" style="display: none;">
                </div>
                
                <div style="margin-bottom: 24px;">
                    <textarea name="post" id="postText" placeholder="<?php echo $t[$lang]['placeholder']; ?>" rows="4" maxlength="1000" style="width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; background: #f8f9fa;"></textarea>
                    <div style="text-align: right; color: #718096; font-size: 13px; margin-top: 8px;">
                        <span id="charCount">0</span>/1000
                    </div>
                </div>
                
                <button type="submit" style="width: 100%; background: linear-gradient(135deg, #a8d5e2 0%, #ffd89b 100%); color: white; border: none; padding: 16px; font-size: 17px; font-weight: 600; border-radius: 12px; cursor: pointer;">
                    <?php echo $t[$lang]['publish']; ?>
                </button>
            </form>
        </div>
    </section>

    <!-- Posts Feed -->
    <section style="padding: 60px 20px; background: #faf9f7;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <h3 style="text-align: center; font-size: 32px; font-weight: 700; margin-bottom: 40px;"><?php echo $t[$lang]['latest_posts']; ?></h3>
            
            <!-- View Controls -->
            <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 40px; flex-wrap: wrap;">
                <button onclick="changeView('grid')" data-view="grid" class="view-btn" style="background: #a8d5e2; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer;">
                    <?php echo $t[$lang]['view_grid']; ?>
                </button>
                <button onclick="changeView('vertical')" data-view="vertical" class="view-btn" style="background: white; color: #2d3748; border: 2px solid #e2e8f0; padding: 10px 20px; border-radius: 25px; cursor: pointer;">
                    <?php echo $t[$lang]['view_vertical']; ?>
                </button>
                <button onclick="changeView('horizontal')" data-view="horizontal" class="view-btn" style="background: white; color: #2d3748; border: 2px solid #e2e8f0; padding: 10px 20px; border-radius: 25px; cursor: pointer;">
                    <?php echo $t[$lang]['view_horizontal']; ?>
                </button>
            </div>
            
            <div id="postsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 28px;">
                <?php
                if (count($posts) > 0) {
                    foreach ($posts as $row) {
                        echo '<div class="post-card" style="background: white; border-radius: 18px; overflow: hidden; border: 1px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">';
                        
                        if (!empty($row['photourl'])) {
                            echo '<div style="width: 100%; height: 280px; overflow: hidden; background: #f5f7fa;">';
                            echo '<img src="/uploads/' . htmlspecialchars($row['photourl']) . '" style="width: 100%; height: 100%; object-fit: cover;">';
                            echo '</div>';
                        }
                        
                        echo '<div style="padding: 24px;">';
                        echo '<p style="margin-bottom: 16px; word-wrap: break-word;">' . nl2br(htmlspecialchars($row['post'])) . '</p>';
                        echo '</div>';
                        echo '</div>';
                    }
                } else {
                    echo '<div style="text-align: center; padding: 80px 20px; color: #718096; grid-column: 1 / -1;">';
                    echo '<p style="font-size: 18px;">' . $t[$lang]['no_posts'] . '</p>';
                    echo '</div>';
                }
                ?>
            </div>
        </div>
    </section>

    <script>
        function previewImage(event) {
            const preview = document.getElementById('preview');
            const uploadText = document.getElementById('uploadText');
            const file = event.target.files[0];
            
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.padding = '0';
                    if (uploadText) uploadText.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }
        
        function changeView(viewType) {
            const container = document.getElementById('postsContainer');
            const buttons = document.querySelectorAll('.view-btn');
            
            if (viewType === 'grid') {
                container.style.display = 'grid';
                container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(320px, 1fr))';
            } else if (viewType === 'vertical') {
                container.style.display = 'grid';
                container.style.gridTemplateColumns = '1fr';
                container.style.maxWidth = '700px';
            } else if (viewType === 'horizontal') {
                container.style.display = 'flex';
                container.style.overflowX = 'auto';
                container.style.gridTemplateColumns = 'none';
            }
            
            buttons.forEach(btn => {
                if (btn.getAttribute('data-view') === viewType) {
                    btn.style.background = '#a8d5e2';
                    btn.style.color = 'white';
                    btn.style.border = 'none';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = '#2d3748';
                    btn.style.border = '2px solid #e2e8f0';
                }
            });
        }
        
        const postText = document.getElementById('postText');
        const charCount = document.getElementById('charCount');
        if (postText && charCount) {
            postText.addEventListener('input', function() {
                charCount.textContent = this.value.length;
            });
        }
    </script>
</body>
</html>

# Componente: `admin.php` (Panel de Control)

## Análisis de Funcionalidades:

### Seguridad de Acceso:
Implementa un middleware de autenticación basado en sesiones. Compara las credenciales recibidas vía POST con constantes definidas en el sistema.

### Dashboard de Estado:
Proporciona visibilidad administrativa sobre el volumen de datos. Realiza consultas agregadas (`COUNT`) para monitorizar cuántas publicaciones y archivos multimedia residen en el sistema.

### Interfaz de Moderación:
Muestra una tabla detallada con los IDs de publicación, permitiendo a los administradores disparar peticiones de borrado seguro.

## Código Fuente:

```php
<?php
session_start();

$error = '';

// Procesar login
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['username']) && isset($_POST['password'])) {
    if ($_POST['username'] === 'admin' && $_POST['password'] === 'extagramG2') {
        $_SESSION['admin_logged'] = true;
        header('Location: /admin.php');
        exit;
    } else {
        $error = 'Usuario o contraseña incorrectos';
    }
}

// Logout
if (isset($_GET['logout'])) {
    session_destroy();
    header('Location: /');
    exit;
}

// Si no está logueado, mostrar formulario
if (!isset($_SESSION['admin_logged'])) {
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin Login</title>
</head>
<body style="margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #a8d5e2 0%, #ffd89b 100%);">
    <div style="background: white; padding: 48px; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); max-width: 420px; width: 100%;">
        <h2 style="font-size: 32px; text-align: center; margin-bottom: 24px;">Admin Panel</h2>
        <?php if ($error): ?>
            <div style="background: #ffe5e5; color: #d63031; text-align: center; margin-bottom: 20px; padding: 12px; border-radius: 8px;"><?php echo $error; ?></div>
        <?php endif; ?>
        <form method="POST">
            <input type="text" name="username" placeholder="Usuario" required autofocus style="width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 16px; font-size: 17px;">
            <input type="password" name="password" placeholder="Contraseña" required style="width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: 12px; margin-bottom: 16px; font-size: 17px;">
            <button type="submit" style="width: 100%; background: linear-gradient(135deg, #a8d5e2 0%, #ffd89b 100%); color: white; border: none; padding: 16px; font-size: 17px; font-weight: 600; border-radius: 12px; cursor: pointer;">Ingresar</button>
        </form>
        <div style="text-align: center; margin-top: 20px;">
            <a href="/" style="color: #718096; text-decoration: none;">← Volver al inicio</a>
        </div>
    </div>
</body>
</html>
<?php
    exit;
}

// Conexión a base de datos (S7)
mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);
try {
    $db = new mysqli("s7-database", "extagram_admin", "pass123", "extagram_db");
    $db->set_charset("utf8mb4");
} catch (mysqli_sql_exception $e) {
    die("Error de conexión: " . $e->getMessage());
}
?>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel</title>
</head>
<body style="margin: 0; background: #faf9f7;">
    <div style="background: linear-gradient(135deg, #a8d5e2 0%, #ffd89b 100%); color: white; padding: 24px 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
        <div style="max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center;">
            <h1 style="font-size: 28px; margin: 0;">Panel de Administración</h1>
            <div style="display: flex; gap: 12px;">
                <a href="/" style="background: rgba(255,255,255,0.25); color: white; border: none; padding: 10px 20px; border-radius: 20px; text-decoration: none; font-weight: 500;">Inicio</a>
                <a href="/admin.php?logout=1" style="background: rgba(255,255,255,0.25); color: white; border: none; padding: 10px 20px; border-radius: 20px; text-decoration: none; font-weight: 500;">Salir</a>
            </div>
        </div>
    </div>

    <div style="padding: 50px 20px; max-width: 1200px; margin: 0 auto;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 24px; margin-bottom: 50px;">
            <?php
            $totalPosts = $db->query("SELECT COUNT(*) as count FROM posts")->fetch_assoc()['count'];
            $postsWithImage = $db->query("SELECT COUNT(*) as count FROM posts WHERE photourl IS NOT NULL")->fetch_assoc()['count'];
            ?>
            
            <div style="background: white; padding: 32px; border-radius: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                <h3 style="font-size: 48px; font-weight: 700; color: #a8d5e2; margin-bottom: 12px;"><?php echo $totalPosts; ?></h3>
                <p style="color: #718096; font-size: 16px;">Total Posts</p>
            </div>
            <div style="background: white; padding: 32px; border-radius: 20px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                <h3 style="font-size: 48px; font-weight: 700; color: #ffd89b; margin-bottom: 12px;"><?php echo $postsWithImage; ?></h3>
                <p style="color: #718096; font-size: 16px;">Con Imágenes</p>
            </div>
        </div>

        <div style="background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
            <h2 style="padding: 28px; border-bottom: 1px solid #e2e8f0; font-size: 26px; margin: 0;">Todas las Publicaciones</h2>
            <?php
            $result = $db->query("SELECT * FROM posts ORDER BY id DESC");
            
            if ($result && $result->num_rows > 0) {
                while ($row = $result->fetch_assoc()) {
                    echo '<div style="padding: 24px 28px; border-bottom: 1px solid #e2e8f0; display: flex; gap: 20px; align-items: center;">';
                    
                    if (!empty($row['photourl'])) {
                        echo '<img src="/uploads/' . htmlspecialchars($row['photourl']) . '" style="width: 90px; height: 90px; border-radius: 12px; object-fit: cover;">';
                    } else {
                        echo '<div style="width: 90px; height: 90px; border-radius: 12px; background: #f5f7fa; display: flex; align-items: center; justify-content: center;"></div>';
                    }
                    
                    echo '<div style="flex: 1;">';
                    echo '<h4 style="font-size: 16px; margin-bottom: 8px;">' . htmlspecialchars(substr($row['post'], 0, 100)) . '</h4>';
                    echo '<p style="color: #718096; font-size: 13px;">ID: ' . $row['id'] . ' | ' . $row['created_at'] . '</p>';
                    echo '</div>';
                    
                    echo '<form method="POST" action="/delete.php" style="margin: 0;">';
                    echo '<input type="hidden" name="post_id" value="' . $row['id'] . '">';
                    echo '<button type="submit" onclick="return confirm(\'¿Seguro?\')" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: 600;">Eliminar</button>';
                    echo '</form>';
                    
                    echo '</div>';
                }
            }
            
            $db->close();
            ?>
        </div>
    </div>
</body>
</html>

# Componente: `delete.php` (Motor de Eliminación)

## Análisis de Funcionalidades:

### Integridad Referencial:
Este script asegura que no queden "archivos huérfanos". Antes de borrar un registro de la base de datos, localiza y elimina físicamente el archivo de imagen del almacenamiento del servidor.

### Seguridad SQL:
Utiliza Sentencias Preparadas (Prepared Statements) para evitar ataques de inyección SQL. El ID de la publicación se trata estrictamente como un entero.

### Gestión de Errores:
Incluye bloques try-catch para manejar fallos en la conexión o problemas de permisos al intentar borrar archivos del disco.

## Código Fuente:

```php
<?php
session_start();

if (!isset($_SESSION['admin_logged'])) {
    header('Location: /admin.php');
    exit;
}

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['post_id'])) {
    $postId = intval($_POST['post_id']);
    
    mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);
    try {
        $db = new mysqli("s7-database", "extagram_admin", "pass123", "extagram_db");
        $db->set_charset("utf8mb4");
        
        $stmt = $db->prepare("SELECT photourl FROM posts WHERE id = ?");
        $stmt->bind_param("i", $postId);
        $stmt->execute();
        $result = $stmt->get_result();
        
        if ($row = $result->fetch_assoc()) {
            if (!empty($row['photourl']) && file_exists('/var/www/html/uploads/' . $row['photourl'])) {
                unlink('/var/www/html/uploads/' . $row['photourl']);
            }
            
            $deleteStmt = $db->prepare("DELETE FROM posts WHERE id = ?");
            $deleteStmt->bind_param("i", $postId);
            $deleteStmt->execute();
        }
        
        $db->close();
    } catch (mysqli_sql_exception $e) {
        // Error silencioso
    }
}

header('Location: /admin.php?deleted=1');
exit;
?>

