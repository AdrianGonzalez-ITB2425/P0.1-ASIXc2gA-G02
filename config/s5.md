# Documentació Tècnica del Servei d'Imatges (s5-images)

L'arxiu de configuració `s5.conf` regeix el comportament del microservei **`s5-images`**. Dins de l'arquitectura de microserveis d'**Extagram**, aquest contenidor té un rol crític: actuar com a **CDN (Content Delivery Network) local**.

A diferència dels serveis de backend (S2, S3), aquest servei no processa codi (PHP/Python); la seva única funció és lliurar contingut estàtic (imatges `.jpg`, `.png`, etc.) directament des del disc al navegador de l'usuari amb la mínima latència possible.

---

## 1. Configuració del Bloc de Servidor i Escolta

Aquest bloc defineix els paràmetres bàsics de connexió i l'abast del servei dins la xarxa `extanet`.

### Directives de Connexió
* **`listen 80;`**
    * El servidor escolta el trànsit HTTP estàndard al port 80.
    * **Context Arquitectònic:** No es configura SSL (port 443) aquí perquè la terminació SSL es realitza al **Proxy Invers (S1)**. La comunicació entre S1 i S5 dins la xarxa Docker és plana (HTTP) per reduir la sobrecàrrega de processament d'encriptació interna, maximitzant la velocitat de transferència d'arxius.
* **`server_name _;`**
    * Configurat com a *catch-all*. Això indica a Nginx que accepti **totes** les peticions que arribin a aquest contenidor, independentment del nom de domini (Host Header) que s'hagi utilitzat. Això simplifica la configuració interna, ja que el ruteig ja ha estat filtrat prèviament pel Proxy Invers.

### Sistema de Fitxers (Filesystem)
* **`root /var/www/html;`**
    * Defineix l'arrel del document per a totes les peticions.
    * **Integració amb Docker:** Aquesta ruta correspon al volum muntat `./uploads` definit al `docker-compose.yml`. Quan Nginx serveix un fitxer des d'aquí, està llegint directament la carpeta física on els usuaris han pujat les seves fotos, garantint persistència de dades.

---

## 2. Optimització del Lliurament d'Imatges (`location /`)

Aquesta secció conté la lògica principal per a la gestió de les imatges pujades pels usuaris. Està dissenyada per minimitzar l'ús de disc i ample de banda (bandwidth).

### Gestió Eficient de Peticions
* **`try_files $uri $uri/ =404;`**
    * Aquesta directiva és fonamental per al rendiment. Nginx comprova l'existència del fitxer en disc.
    * **Comportament:** Si la imatge existeix, la serveix immediatament. Si no (per exemple, si un usuari demana una foto esborrada), retorna un error `404 Not Found` **sense executar cap script ni procés addicional**. Això protegeix el servidor de malgastar recursos en enllaços trencats.

### Estratègia de Memòria Cau (Caching) i Rendiment
L'objectiu és que el navegador de l'usuari descarregui la imatge una sola vegada i no la torni a demanar al servidor.

1.  **`expires 30d;`**
    * Estableix la data de caducitat del recurs en 30 dies. Això és ideal per a xarxes socials, on les fotos de perfil o posts antics rarament canvien un cop pujats.
    * **Impacte:** Redueix dràsticament les peticions HTTP en visites successives.

2.  **`add_header Cache-Control "public, immutable";`**
    * **`public`:** Autoritza a servidors intermedis (com proxies corporatius o CDNs externes) a emmagatzemar una còpia de la imatge.
    * **`immutable`:** Aquesta és una optimització moderna clau. Indica al navegador que **aquest fitxer mai canviarà de contingut**.
        * *Sense immutable:* El navegador preguntaria al servidor: "Ha canviat la foto 123.jpg?" (Petició 304 Not Modified).
        * *Amb immutable:* El navegador ni tan sols pregunta; utilitza la còpia local directament, eliminant completament la latència de xarxa.

---

## 3. Observabilitat i Depuració (Logs)

Per facilitar el manteniment i la detecció d'errors, s'han segregat els registres d'aquest servei:

* **`access_log /var/log/nginx/s5-access.log;`**
    * Registra cada descàrrega. Útil per analitzar patrons de trànsit, imatges més populars o consum d'ample de banda.
* **`error_log /var/log/nginx/s5-error.log;`**
    * Crític per detectar problemes de permisos al volum `./uploads` o imatges que falten (Errors 404 massius).

---

## 4. Seguretat i Enduriment (`Hardening`)

Encara que sigui un servidor intern, s'aplica una capa de seguretat per protegir l'estructura de fitxers.

* **Bloc `location ~ /\. { deny all; }`**
    * Utilitza una expressió regular per interceptar qualsevol intent d'accedir a fitxers o carpetes "ocultes" (aquells que comencen per un punt).
    * **Vectors d'atac mitigats:**
        * Evita l'accés a `.git` (si es fes servir control de versions a la carpeta uploads).
        * Evita l'accés a arxius de sistema com `.DS_Store` o fitxers de configuració `.env` que puguin haver estat copiats accidentalment al directori d'imatges.
    * **Acció:** Retorna un error `403 Forbidden` immediatament.

---

## Resum Tècnic de Directives

| Directiva | Valor | Explicació Tècnica | Impacte en Extagram |
| :--- | :--- | :--- | :--- |
| `listen` | `80` | Protocol HTTP sense xifratge. | Alta velocitat en comunicació intra-docker (S1 -> S5). |
| `root` | `/var/www/html` | Mapeig al volum `./uploads`. | Accés directe al disc físic per servir fotos. |
| `expires` | `30d` | Cache de navegador de llarga durada. | Estalvi d'ample de banda i CPU del servidor. |
| `Cache-Control` | `immutable` | Directiva d'estaticitat total. | Elimina peticions de re-validació (Status 304). |
| `try_files` | `$uri ... =404` | Comprovació d'existència física. | Evita processament innecessari en 404s. |
| `deny` | `all` | Bloqueig per patró (Regex). | Protecció contra fuites d'informació sensible. |

---

## Arxiu de Configuració Complet: `s5.conf`

```nginx
server {
    # 1. Configuració de port i host
    listen 80;
    server_name _;
    
    # 2. Definició de l'arrel (connectat al volum ./uploads)
    root /var/www/html;

    # 3. Lògica principal de lliurament d'imatges
    location / {
        # Intenta servir el fitxer, si no existeix, retorna 404 directament
        try_files $uri $uri/ =404;
        
        # 4. Optimització de Memòria Cau (Caching)
        # Els fitxers es guarden 30 dies al navegador
        expires 30d;
        # 'immutable' evita que el navegador comprovi si el fitxer ha canviat
        add_header Cache-Control "public, immutable";
        
        # 5. Registres específics per a aquest microservei
        access_log /var/log/nginx/s5-access.log;
        error_log /var/log/nginx/s5-error.log;
    }

    # 6. Seguretat: Bloqueig d'arxius ocults (dotfiles)
    # Protegeix contra l'exposició de .git, .env, etc.
    location ~ /\. {
        deny all;
    }
}
```

[Torna a l'Inici](../README.md)